name: Build Android APK (Signed Release)

on:
  workflow_dispatch:

jobs:
  build_signed_release:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Setup Java 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17

      - name: Detect project + android directories
        shell: bash
        run: |
          set -e
          echo "Repo root:"
          ls -la

          if [ -f "RMPM_Mobile_Capacitor/package.json" ]; then
            echo "PROJECT_DIR=RMPM_Mobile_Capacitor" >> "$GITHUB_ENV"
            echo "ANDROID_DIR=RMPM_Mobile_Capacitor/android" >> "$GITHUB_ENV"
          elif [ -f "package.json" ]; then
            echo "PROJECT_DIR=." >> "$GITHUB_ENV"
            echo "ANDROID_DIR=android" >> "$GITHUB_ENV"
          else
            echo "ERROR: package.json not found in repo root or RMPM_Mobile_Capacitor/"
            exit 1
          fi

          echo "PROJECT_DIR resolved to: $(cat $GITHUB_ENV | grep PROJECT_DIR | cut -d= -f2)"
          echo "ANDROID_DIR resolved to: $(cat $GITHUB_ENV | grep ANDROID_DIR | cut -d= -f2)"

      - name: Install deps
        working-directory: ${{ env.PROJECT_DIR }}
        run: npm ci

      - name: Build web (optional)
        working-directory: ${{ env.PROJECT_DIR }}
        run: npm run build || echo "no build script, continuing"

      - name: Ensure Android platform exists
        working-directory: ${{ env.PROJECT_DIR }}
        run: npx cap add android || echo "android already exists"

      - name: Sync Capacitor Android
        working-directory: ${{ env.PROJECT_DIR }}
        run: npx cap sync android

      - name: Restore keystore + write keystore.properties
        working-directory: ${{ env.ANDROID_DIR }}
        env:
          ANDROID_KEYSTORE_B64: ${{ secrets.ANDROID_KEYSTORE_B64 }}
          ANDROID_KEYSTORE_PASSWORD: ${{ secrets.ANDROID_KEYSTORE_PASSWORD }}
          ANDROID_KEY_ALIAS: ${{ secrets.ANDROID_KEY_ALIAS }}
          ANDROID_KEY_PASSWORD: ${{ secrets.ANDROID_KEY_PASSWORD }}
        shell: bash
        run: |
          set -e

          test -n "$ANDROID_KEYSTORE_B64" || (echo "ERROR: ANDROID_KEYSTORE_B64 secret is empty" && exit 1)
          test -n "$ANDROID_KEYSTORE_PASSWORD" || (echo "ERROR: ANDROID_KEYSTORE_PASSWORD secret is empty" && exit 1)
          test -n "$ANDROID_KEY_ALIAS" || (echo "ERROR: ANDROID_KEY_ALIAS secret is empty" && exit 1)
          test -n "$ANDROID_KEY_PASSWORD" || (echo "ERROR: ANDROID_KEY_PASSWORD secret is empty" && exit 1)

          # decode keystore into android/app/
          mkdir -p app
          echo "$ANDROID_KEYSTORE_B64" | tr -d '\n\r' | base64 -d > app/rmpm-release.keystore
          test -f app/rmpm-release.keystore

          # write keystore.properties (NO heredoc -> avoids YAML parser issues)
          printf "storeFile=rmpm-release.keystore\n" > keystore.properties
          printf "storePassword=%s\n" "$ANDROID_KEYSTORE_PASSWORD" >> keystore.properties
          printf "keyAlias=%s\n" "$ANDROID_KEY_ALIAS" >> keystore.properties
          printf "keyPassword=%s\n" "$ANDROID_KEY_PASSWORD" >> keystore.properties

          # show file but hide passwords
          sed -i 's/storePassword=.*/storePassword=***hidden***/' keystore.properties
          sed -i 's/keyPassword=.*/keyPassword=***hidden***/' keystore.properties
          cat keystore.properties

      - name: Make gradlew executable
        working-directory: ${{ env.ANDROID_DIR }}
        run: chmod +x ./gradlew

      - name: Build Release APK (assembleRelease)
        working-directory: ${{ env.ANDROID_DIR }}
        run: ./gradlew clean assembleRelease

      - name: Install Android build-tools (zipalign + apksigner)
        shell: bash
        run: |
          set -e
          ANDROID_SDK="${ANDROID_SDK_ROOT:-${ANDROID_HOME}}"
          echo "ANDROID_SDK=$ANDROID_SDK"
          SDKMANAGER="$ANDROID_SDK/cmdline-tools/latest/bin/sdkmanager"

          if [ ! -x "$SDKMANAGER" ]; then
            echo "ERROR: sdkmanager not found at $SDKMANAGER"
            ls -la "$ANDROID_SDK" || true
            exit 1
          fi

          "$SDKMANAGER" --licenses || true

          for i in 1 2 3; do
            echo "Install attempt $i..."
            "$SDKMANAGER" --install "platform-tools" "build-tools;34.0.0" && break
            sleep 3
          done

          test -f "$ANDROID_SDK/build-tools/34.0.0/zipalign"
          test -f "$ANDROID_SDK/build-tools/34.0.0/apksigner"
          echo "$ANDROID_SDK/build-tools/34.0.0" >> "$GITHUB_PATH"

      - name: Find unsigned release APK
        id: find_apk
        shell: bash
        run: |
          set -e
          APK_PATH="${{ env.ANDROID_DIR }}/app/build/outputs/apk/release/app-release-unsigned.apk"
          if [ ! -f "$APK_PATH" ]; then
            echo "ERROR: Unsigned APK not found at: $APK_PATH"
            echo "Listing outputs:"
            ls -la "${{ env.ANDROID_DIR }}/app/build/outputs/apk" || true
            ls -la "${{ env.ANDROID_DIR }}/app/build/outputs/apk/release" || true
            exit 1
          fi
          echo "apk_path=$APK_PATH" >> "$GITHUB_OUTPUT"
          echo "Found: $APK_PATH"

      - name: Sign release APK
        working-directory: ${{ env.ANDROID_DIR }}
        env:
          ANDROID_KEYSTORE_PASSWORD: ${{ secrets.ANDROID_KEYSTORE_PASSWORD }}
          ANDROID_KEY_ALIAS: ${{ secrets.ANDROID_KEY_ALIAS }}
          ANDROID_KEY_PASSWORD: ${{ secrets.ANDROID_KEY_PASSWORD }}
        shell: bash
        run: |
          set -e
          UNSIGNED="${{ steps.find_apk.outputs.apk_path }}"
          SIGNED="${{ env.ANDROID_DIR }}/app/build/outputs/apk/release/app-release-signed.apk"

          apksigner sign \
            --ks app/rmpm-release.keystore \
            --ks-pass "pass:$ANDROID_KEYSTORE_PASSWORD" \
            --ks-key-alias "$ANDROID_KEY_ALIAS" \
            --key-pass "pass:$ANDROID_KEY_PASSWORD" \
            --out "$SIGNED" \
            "$UNSIGNED"

          apksigner verify --verbose "$SIGNED"

          zipalign -v -p 4 "$SIGNED" "${SIGNED}.aligned"
          mv -f "${SIGNED}.aligned" "$SIGNED"

          ls -la "$SIGNED"

      - name: Upload Release APK (SIGNED)
        uses: actions/upload-artifact@v4
        with:
          name: app-release-signed
          path: RMPM_Mobile_Capacitor/android/app/build/outputs/apk/release/app-release-signed.apk

      - name: Upload Release APK (UNSIGNED) (debugging)
        uses: actions/upload-artifact@v4
        with:
          name: app-release-unsigned
          path: RMPM_Mobile_Capacitor/android/app/build/outputs/apk/release/app-release-unsigned.apk
