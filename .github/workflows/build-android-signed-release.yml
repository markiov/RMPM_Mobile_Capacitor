name: Build Android APK (Signed Release)

on:
  workflow_dispatch:

jobs:
  build_signed_release:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Setup Java 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17

      - name: Detect project + android directories
        shell: bash
        run: |
          set -e
          echo "Repo root:"
          ls -la

          if [ -f "RMPM_Mobile_Capacitor/package.json" ]; then
            echo "PROJECT_DIR=RMPM_Mobile_Capacitor" >> "$GITHUB_ENV"
            echo "ANDROID_DIR=RMPM_Mobile_Capacitor/android" >> "$GITHUB_ENV"
          elif [ -f "package.json" ]; then
            echo "PROJECT_DIR=." >> "$GITHUB_ENV"
            echo "ANDROID_DIR=android" >> "$GITHUB_ENV"
          else
            echo "ERROR: package.json not found in repo root or RMPM_Mobile_Capacitor/"
            exit 1
          fi

          echo "Resolved env:"
          cat "$GITHUB_ENV" | grep -E "PROJECT_DIR|ANDROID_DIR" || true

      - name: Install deps
        working-directory: ${{ env.PROJECT_DIR }}
        run: npm ci

      - name: Build web (optional)
        working-directory: ${{ env.PROJECT_DIR }}
        run: npm run build || echo "no build script, continuing"

      - name: Ensure Android platform exists
        working-directory: ${{ env.PROJECT_DIR }}
        run: npx cap add android || echo "android already exists"

      - name: Sync Capacitor Android
        working-directory: ${{ env.PROJECT_DIR }}
        run: npx cap sync android

      - name: Restore keystore + write keystore.properties
        working-directory: ${{ env.ANDROID_DIR }}
        env:
          ANDROID_KEYSTORE_B64: ${{ secrets.ANDROID_KEYSTORE_B64 }}
          ANDROID_KEYSTORE_PASSWORD: ${{ secrets.ANDROID_KEYSTORE_PASSWORD }}
          ANDROID_KEY_ALIAS: ${{ secrets.ANDROID_KEY_ALIAS }}
          ANDROID_KEY_PASSWORD: ${{ secrets.ANDROID_KEY_PASSWORD }}
        shell: bash
        run: |
          set -e

          test -n "$ANDROID_KEYSTORE_B64" || (echo "ERROR: ANDROID_KEYSTORE_B64 secret is empty" && exit 1)
          test -n "$ANDROID_KEYSTORE_PASSWORD" || (echo "ERROR: ANDROID_KEYSTORE_PASSWORD secret is empty" && exit 1)
          test -n "$ANDROID_KEY_ALIAS" || (echo "ERROR: ANDROID_KEY_ALIAS secret is empty" && exit 1)
          test -n "$ANDROID_KEY_PASSWORD" || (echo "ERROR: ANDROID_KEY_PASSWORD secret is empty" && exit 1)

          mkdir -p app
          echo "$ANDROID_KEYSTORE_B64" | tr -d '\n\r' | base64 -d > app/rmpm-release.keystore
          test -f app/rmpm-release.keystore

          # keystore.properties in ANDROID_DIR root
          printf "storeFile=rmpm-release.keystore\n" > keystore.properties
          printf "storePassword=%s\n" "$ANDROID_KEYSTORE_PASSWORD" >> keystore.properties
          printf "keyAlias=%s\n" "$ANDROID_KEY_ALIAS" >> keystore.properties
          printf "keyPassword=%s\n" "$ANDROID_KEY_PASSWORD" >> keystore.properties

          # show but hide passwords
          sed -i 's/storePassword=.*/storePassword=***hidden***/' keystore.properties
          sed -i 's/keyPassword=.*/keyPassword=***hidden***/' keystore.properties
          cat keystore.properties

      - name: Make gradlew executable
        working-directory: ${{ env.ANDROID_DIR }}
        run: chmod +x ./gradlew

      - name: Build Release APK (assembleRelease)
        working-directory: ${{ env.ANDROID_DIR }}
        run: ./gradlew clean assembleRelease

      - name: Install Android build-tools (zipalign + apksigner)
        shell: bash
        run: |
          set -e
          ANDROID_SDK="${ANDROID_SDK_ROOT:-${ANDROID_HOME}}"
          echo "ANDROID_SDK=$ANDROID_SDK"
          SDKMANAGER="$ANDROID_SDK/cmdline-tools/latest/bin/sdkmanager"

          if [ ! -x "$SDKMANAGER" ]; then
            echo "ERROR: sdkmanager not found at $SDKMANAGER"
            ls -la "$ANDROID_SDK" || true
            exit 1
          fi

          "$SDKMANAGER" --licenses || true

          # Install recent build-tools (34.0.0 has zipalign + apksigner)
          for i in 1 2 3; do
            echo "Install attempt $i..."
            "$SDKMANAGER" --install "platform-tools" "build-tools;34.0.0" && break
            sleep 3
          done

          test -f "$ANDROID_SDK/build-tools/34.0.0/zipalign"
          test -f "$ANDROID_SDK/build-tools/34.0.0/apksigner"
          echo "$ANDROID_SDK/build-tools/34.0.0" >> "$GITHUB_PATH"

      - name: Locate release APK (any name)
        id: locate
        shell: bash
        run: |
          set -e
          OUTDIR="${{ env.ANDROID_DIR }}/app/build/outputs/apk/release"
          echo "Listing: $OUTDIR"
          ls -la "$OUTDIR" || true

          # Prefer unsigned if it exists, otherwise take any release apk
          APK=""
          if [ -f "$OUTDIR/app-release-unsigned.apk" ]; then
            APK="$OUTDIR/app-release-unsigned.apk"
          else
            APK="$(ls -1 "$OUTDIR"/*.apk 2>/dev/null | head -n 1 || true)"
          fi

          if [ -z "$APK" ] || [ ! -f "$APK" ]; then
            echo "ERROR: No release APK found in $OUTDIR"
            exit 1
          fi

          echo "Found APK: $APK"
          echo "apk_path=$APK" >> "$GITHUB_OUTPUT"

      - name: Sign if needed + verify + zipalign
        id: sign_or_verify
        working-directory: ${{ env.ANDROID_DIR }}
        env:
          ANDROID_KEYSTORE_PASSWORD: ${{ secrets.ANDROID_KEYSTORE_PASSWORD }}
          ANDROID_KEY_ALIAS: ${{ secrets.ANDROID_KEY_ALIAS }}
          ANDROID_KEY_PASSWORD: ${{ secrets.ANDROID_KEY_PASSWORD }}
        shell: bash
        run: |
          set -e

          INAPK="${{ steps.locate.outputs.apk_path }}"
          OUTDIR="${{ env.ANDROID_DIR }}/app/build/outputs/apk/release"
          SIGNED="$OUTDIR/app-release-signed.apk"

          echo "Input APK: $INAPK"

          # Check if already signed (apksigner verify returns 0 if valid)
          if apksigner verify --verbose "$INAPK" >/dev/null 2>&1; then
            echo "APK already signed -> will use it as signed output"
            cp -f "$INAPK" "$SIGNED"
          else
            echo "APK not signed -> signing now..."
            apksigner sign \
              --ks app/rmpm-release.keystore \
              --ks-pass "pass:$ANDROID_KEYSTORE_PASSWORD" \
              --ks-key-alias "$ANDROID_KEY_ALIAS" \
              --key-pass "pass:$ANDROID_KEY_PASSWORD" \
              --out "$SIGNED" \
              "$INAPK"
          fi

          echo "Verify signed:"
          apksigner verify --verbose "$SIGNED"

          echo "Zipalign:"
          zipalign -v -p 4 "$SIGNED" "${SIGNED}.aligned"
          mv -f "${SIGNED}.aligned" "$SIGNED"

          ls -la "$SIGNED"
          echo "signed_apk=$SIGNED" >> "$GITHUB_OUTPUT"

      - name: Upload Release APK (SIGNED)
        uses: actions/upload-artifact@v4
        with:
          name: app-release-signed
          path: ${{ steps.sign_or_verify.outputs.signed_apk }}

      - name: Upload Input Release APK (for debugging)
        uses: actions/upload-artifact@v4
        with:
          name: release-apk-input
          path: ${{ steps.locate.outputs.apk_path }}
