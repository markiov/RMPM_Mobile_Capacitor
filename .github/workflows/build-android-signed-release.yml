name: Build Android APK (Signed Release)

on:
  workflow_dispatch:

jobs:
  build_signed_release:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Setup Java 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "17"

      # Detecteer automatisch waar package.json en android/ staan
      - name: Detect project + android directories
        shell: bash
        run: |
          set -e
          if [ -f "RMPM_Mobile_Capacitor/package.json" ]; then
            PROJECT_DIR="RMPM_Mobile_Capacitor"
          elif [ -f "package.json" ]; then
            PROJECT_DIR="."
          else
            echo "ERROR: package.json not found in repo root or RMPM_Mobile_Capacitor/"
            echo "Repo root contains:"
            ls -la
            exit 1
          fi

          ANDROID_DIR="$PROJECT_DIR/android"
          if [ ! -d "$ANDROID_DIR" ]; then
            echo "ERROR: Android dir not found at: $ANDROID_DIR"
            echo "Project dir contains:"
            ls -la "$PROJECT_DIR"
            exit 1
          fi

          echo "PROJECT_DIR=$PROJECT_DIR" >> $GITHUB_ENV
          echo "ANDROID_DIR=$ANDROID_DIR" >> $GITHUB_ENV

          echo "Using PROJECT_DIR=$PROJECT_DIR"
          echo "Using ANDROID_DIR=$ANDROID_DIR"

      # âœ… FIX: installeer Android build-tools zodat zipalign bestaat
      - name: Install Android build-tools (zipalign)
        shell: bash
        run: |
          set -e
          ANDROID_SDK="${ANDROID_SDK_ROOT:-${ANDROID_HOME}}"
          echo "ANDROID_SDK=$ANDROID_SDK"
          SDKMANAGER="$ANDROID_SDK/cmdline-tools/latest/bin/sdkmanager"

          if [ ! -x "$SDKMANAGER" ]; then
            echo "ERROR: sdkmanager not found at $SDKMANAGER"
            echo "Available in $ANDROID_SDK:"
            ls -la "$ANDROID_SDK" || true
            exit 1
          fi

          yes | "$SDKMANAGER" --install "platform-tools" "build-tools;34.0.0"
          test -f "$ANDROID_SDK/build-tools/34.0.0/zipalign"
          test -f "$ANDROID_SDK/build-tools/34.0.0/apksigner"
          echo "$ANDROID_SDK/build-tools/34.0.0" >> $GITHUB_PATH

      - name: Install deps
        working-directory: ${{ env.PROJECT_DIR }}
        run: npm install

      - name: Build web (optional)
        working-directory: ${{ env.PROJECT_DIR }}
        run: npm run build || echo "no build script, continuing"

      - name: Sync Capacitor Android
        working-directory: ${{ env.PROJECT_DIR }}
        run: npx cap sync android

      - name: Restore keystore + write keystore.properties
        shell: bash
        run: |
          set -e

          test -n "${{ secrets.ANDROID_KEYSTORE_B64 }}" || (echo "ERROR: ANDROID_KEYSTORE_B64 secret is empty" && exit 1)
          test -n "${{ secrets.ANDROID_KEYSTORE_PASSWORD }}" || (echo "ERROR: ANDROID_KEYSTORE_PASSWORD secret is empty" && exit 1)
          test -n "${{ secrets.ANDROID_KEY_ALIAS }}" || (echo "ERROR: ANDROID_KEY_ALIAS secret is empty" && exit 1)
          test -n "${{ secrets.ANDROID_KEY_PASSWORD }}" || (echo "ERROR: ANDROID_KEY_PASSWORD secret is empty" && exit 1)

          echo "${{ secrets.ANDROID_KEYSTORE_B64 }}" | tr -d '\n\r' | base64 -d > "${{ env.ANDROID_DIR }}/app/rmpm-release.keystore"
          test -f "${{ env.ANDROID_DIR }}/app/rmpm-release.keystore"

          cat > "${{ env.ANDROID_DIR }}/keystore.properties" <<EOF
          storeFile=app/rmpm-release.keystore
          storePassword=${{ secrets.ANDROID_KEYSTORE_PASSWORD }}
          keyAlias=${{ secrets.ANDROID_KEY_ALIAS }}
          keyPassword=${{ secrets.ANDROID_KEY_PASSWORD }}
          EOF

      - name: Make gradlew executable
        working-directory: ${{ env.ANDROID_DIR }}
        run: chmod +x ./gradlew

      - name: Build Release APK (assembleRelease)
        working-directory: ${{ env.ANDROID_DIR }}
        run: ./gradlew clean assembleRelease

      - name: Sign release APK
        uses: r0adkll/sign-android-release@v1
        with:
          releaseDirectory: ${{ env.ANDROID_DIR }}/app/build/outputs/apk/release
          signingKeyBase64: ${{ secrets.ANDROID_KEYSTORE_B64 }}
          alias: ${{ secrets.ANDROID_KEY_ALIAS }}
          keyStorePassword: ${{ secrets.ANDROID_KEYSTORE_PASSWORD }}
          keyPassword: ${{ secrets.ANDROID_KEY_PASSWORD }}

      - name: Show APK outputs
        shell: bash
        run: |
          set -e
          echo "APK outputs:"
          ls -la "${{ env.ANDROID_DIR }}/app/build/outputs/apk/release" || true
          find "${{ env.ANDROID_DIR }}/app/build/outputs/apk" -maxdepth 3 -type f -name "*.apk" -print || true

      - name: Upload SIGNED APK artifact
        uses: actions/upload-artifact@v4
        with:
          name: rmpm-signed-release-apk
          path: |
            ${{ env.ANDROID_DIR }}/app/build/outputs/apk/release/*.apk
