name: Build Android APK (Signed Release)

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    defaults:
      run:
        shell: bash

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17

      - name: Detect project directory
        run: |
          set -e
          echo "Repo root listing:"
          ls -la

          if [ -f "RMPM_Mobile_Capacitor/package.json" ]; then
            PROJECT_DIR="RMPM_Mobile_Capacitor"
          elif [ -f "package.json" ]; then
            PROJECT_DIR="."
          else
            echo "ERROR: package.json not found in repo root or RMPM_Mobile_Capacitor/"
            exit 1
          fi

          ANDROID_DIR="${PROJECT_DIR}/android"

          # Export to later steps
          echo "PROJECT_DIR=${PROJECT_DIR}" >> "$GITHUB_ENV"
          echo "ANDROID_DIR=${ANDROID_DIR}" >> "$GITHUB_ENV"

          echo "PROJECT_DIR=$PROJECT_DIR"
          echo "ANDROID_DIR=$ANDROID_DIR"

          # Verify android dir exists
          if [ ! -d "$ANDROID_DIR" ]; then
            echo "ERROR: ANDROID_DIR does not exist: $ANDROID_DIR"
            echo "Listing PROJECT_DIR:"
            ls -la "$PROJECT_DIR" || true
            exit 1
          fi

      - name: Install deps
        working-directory: ${{ env.PROJECT_DIR }}
        run: npm ci

      - name: Ensure Android platform exists
        working-directory: ${{ env.PROJECT_DIR }}
        run: npx cap add android || echo "android already exists"

      - name: Sync Capacitor
        working-directory: ${{ env.PROJECT_DIR }}
        run: npx cap sync android

      - name: Restore keystore + write keystore.properties
        env:
          ANDROID_KEYSTORE_B64: ${{ secrets.ANDROID_KEYSTORE_B64 }}
          ANDROID_KEYSTORE_PASSWORD: ${{ secrets.ANDROID_KEYSTORE_PASSWORD }}
          ANDROID_KEY_ALIAS: ${{ secrets.ANDROID_KEY_ALIAS }}
          ANDROID_KEY_PASSWORD: ${{ secrets.ANDROID_KEY_PASSWORD }}
        run: |
          set -e

          echo "ANDROID_DIR is: $ANDROID_DIR"
          ls -la "$ANDROID_DIR"

          test -n "$ANDROID_KEYSTORE_B64" || (echo "ERROR: ANDROID_KEYSTORE_B64 is empty" && exit 1)
          test -n "$ANDROID_KEYSTORE_PASSWORD" || (echo "ERROR: ANDROID_KEYSTORE_PASSWORD is empty" && exit 1)
          test -n "$ANDROID_KEY_ALIAS" || (echo "ERROR: ANDROID_KEY_ALIAS is empty" && exit 1)
          test -n "$ANDROID_KEY_PASSWORD" || (echo "ERROR: ANDROID_KEY_PASSWORD is empty" && exit 1)

          test -d "$ANDROID_DIR/app" || (echo "ERROR: $ANDROID_DIR/app not found" && ls -la "$ANDROID_DIR" && exit 1)

          echo "$ANDROID_KEYSTORE_B64" | tr -d '\n' | base64 -d > "$ANDROID_DIR/app/rmpm-release.keystore"
          test -f "$ANDROID_DIR/app/rmpm-release.keystore"

          printf "storeFile=app/rmpm-release.keystore\nstorePassword=%s\nkeyAlias=%s\nkeyPassword=%s\n" \
            "$ANDROID_KEYSTORE_PASSWORD" "$ANDROID_KEY_ALIAS" "$ANDROID_KEY_PASSWORD" \
            > "$ANDROID_DIR/keystore.properties"

          # Hide secrets in log
          sed -i 's/storePassword=.*/storePassword=***hidden***/' "$ANDROID_DIR/keystore.properties"
          sed -i 's/keyPassword=.*/keyPassword=***hidden***/' "$ANDROID_DIR/keystore.properties"
          echo "keystore.properties written:"
          cat "$ANDROID_DIR/keystore.properties"

      - name: Build Release APK (SIGNED)
        working-directory: ${{ env.ANDROID_DIR }}
        run: ./gradlew clean assembleRelease

      - name: Show APK outputs
        run: |
          set -e
          echo "APK folder:"
          ls -la "$ANDROID_DIR/app/build/outputs/apk/release" || true
          echo "All APKs found:"
          find "$ANDROID_DIR/app/build/outputs" -name "*.apk" -maxdepth 6 -print || true

      - name: Upload Release APK
        uses: actions/upload-artifact@v4
        with:
          name: rmpm-release-apk
          path: ${{ env.ANDROID_DIR }}/app/build/outputs/apk/release/*.apk
