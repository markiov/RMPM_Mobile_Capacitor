name: Build Android (Debug + Release Signed)

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17

      - name: Install deps
        working-directory: RMPM_Mobile_Capacitor
        run: npm install

      - name: Build web (optional)
        working-directory: RMPM_Mobile_Capacitor
        run: npm run build || echo "no build script, continuing"

      - name: Add Android (if missing)
        working-directory: RMPM_Mobile_Capacitor
        run: npx cap add android || echo "android already exists"

      - name: Sync Capacitor
        working-directory: RMPM_Mobile_Capacitor
        run: npx cap sync android

      # --- Decode keystore from GitHub Secrets ---
      - name: Decode Android keystore
        working-directory: RMPM_Mobile_Capacitor/android
        env:
          ANDROID_KEYSTORE_B64: ${{ secrets.ANDROID_KEYSTORE_B64 }}
        run: |
          echo "$ANDROID_KEYSTORE_B64" | tr -d '\n\r ' | base64 -d > rmpm-release.keystore
          ls -la

      # --- Write signing properties for Gradle ---
      - name: Create signing properties
        working-directory: RMPM_Mobile_Capacitor/android
        env:
          ANDROID_KEY_ALIAS: ${{ secrets.ANDROID_KEY_ALIAS }}
          ANDROID_KEYSTORE_PASSWORD: ${{ secrets.ANDROID_KEYSTORE_PASSWORD }}
          ANDROID_KEY_PASSWORD: ${{ secrets.ANDROID_KEY_PASSWORD }}
        run: |
          cat > keystore.properties <<EOF
          storeFile=rmpm-release.keystore
          storePassword=${ANDROID_KEYSTORE_PASSWORD}
          keyAlias=${ANDROID_KEY_ALIAS}
          keyPassword=${ANDROID_KEY_PASSWORD}
          EOF
          cat keystore.properties | sed 's/storePassword=.*/storePassword=***hidden***/' | sed 's/keyPassword=.*/keyPassword=***hidden***/'

      # --- Ensure app/build.gradle uses keystore.properties (safe append) ---
      - name: Ensure Gradle signing config
        working-directory: RMPM_Mobile_Capacitor/android
        run: |
          if ! grep -q "keystore.properties" app/build.gradle; then
            echo "Patching app/build.gradle for release signing..."
            python3 - <<'PY'
import re, pathlib
p = pathlib.Path("app/build.gradle")
txt = p.read_text(encoding="utf-8")

# Add keystoreProperties loading near top
if "keystorePropertiesFile" not in txt:
    insert = """def keystoreProperties = new Properties()
def keystorePropertiesFile = rootProject.file("keystore.properties")
if (keystorePropertiesFile.exists()) {
    keystoreProperties.load(new FileInputStream(keystorePropertiesFile))
}
"""
    # place after first line or after plugins block
    if "plugins {" in txt:
        m = re.search(r"plugins\s*\{[^}]*\}\s*", txt, re.S)
        if m:
            txt = txt[:m.end()] + "\n" + insert + txt[m.end():]
        else:
            txt = insert + "\n" + txt
    else:
        txt = insert + "\n" + txt

# Ensure signingConfigs/release exists
if "signingConfigs" not in txt:
    # find android { ... } open
    m = re.search(r"android\s*\{", txt)
    if m:
        pos = m.end()
        add = """
    signingConfigs {
        release {
            storeFile file(keystoreProperties['storeFile'])
            storePassword keystoreProperties['storePassword']
            keyAlias keystoreProperties['keyAlias']
            keyPassword keystoreProperties['keyPassword']
        }
    }
"""
        txt = txt[:pos] + add + txt[pos:]
else:
    # if signingConfigs exists but no release, inject a release block
    if re.search(r"signingConfigs\s*\{[^}]*release\s*\{", txt, re.S) is None:
        txt = re.sub(r"signingConfigs\s*\{", r"signingConfigs {\n        release {\n            storeFile file(keystoreProperties['storeFile'])\n            storePassword keystoreProperties['storePassword']\n            keyAlias keystoreProperties['keyAlias']\n            keyPassword keystoreProperties['keyPassword']\n        }\n", txt, count=1)

# Ensure buildTypes.release.signingConfig = signingConfigs.release
if re.search(r"buildTypes\s*\{", txt) and re.search(r"buildTypes\s*\{[^}]*release\s*\{", txt, re.S):
    # if release block exists but no signingConfig line, add it
    def add_signing(m):
        block = m.group(0)
        if "signingConfig" in block:
            return block
        return block + "\n            signingConfig signingConfigs.release\n"
    txt = re.sub(r"release\s*\{[^}]*\}", add_signing, txt, count=1, flags=re.S)

p.write_text(txt, encoding="utf-8")
print("OK")
PY
          fi

      - name: Build Debug APK
        working-directory: RMPM_Mobile_Capacitor/android
        run: ./gradlew assembleDebug

      - name: Build Release APK (signed)
        working-directory: RMPM_Mobile_Capacitor/android
        run: ./gradlew assembleRelease

      - name: Build Release AAB (signed)
        working-directory: RMPM_Mobile_Capacitor/android
        run: ./gradlew bundleRelease

      - name: Upload Debug APK
        uses: actions/upload-artifact@v4
        with:
          name: app-debug-apk
          path: RMPM_Mobile_Capacitor/android/app/build/outputs/apk/debug/app-debug.apk

      - name: Upload Release APK
        uses: actions/upload-artifact@v4
        with:
          name: app-release-apk-signed
          path: RMPM_Mobile_Capacitor/android/app/build/outputs/apk/release/app-release.apk

      - name: Upload Release AAB
        uses: actions/upload-artifact@v4
        with:
          name: app-release-aab-signed
          path: RMPM_Mobile_Capacitor/android/app/build/outputs/bundle/release/app-release.aab
